{% extends 'base.html' %}

{% block content %}
{{ trade.close_date }}
<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h1>{{ trade.symbol }}</h1>
                        <h6>{{ trade.formatted_open_date }}</h6>
                        <h6>{{ trade.instrument }}</h6>
                        <h6>Portfolio: {{ trade.portfolio.name }}</h6>
                    </div>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                        {% if trade.pnl >= 0 %}
                        <h5 class="text-success font-weight-bold">NET P&L</h5>
                        <h5 class="text-success font-weight-bold">${{ trade.pnl }}</h5>
                        {% else %}
                        <h5 class="text-danger font-weight-bold">NET P&L</h5>
                        <h5 class="text-danger font-weight-bold">${{ trade.pnl }}</h5>
                        {% endif %}
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <h5
                            class="{% if trade.pnl_percent >= 0 %}text-success{% else %}text-danger{% endif %} font-weight-bold">
                            Net ROI</h5>
                        <h5
                            class="text-end {% if trade.pnl_percent >= 0 %}text-success{% else %}text-danger{% endif %} font-weight-bold">
                            {{ trade.pnl_percent }}%</h5>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Status</span>
                        <span>
                            {% if trade.status == 'WIN' %}
                            <span class="badge bg-success">{{ trade.status }}</span>
                            {% elif trade.status == 'LOSS' %}
                            <span class="badge bg-danger">{{ trade.status }}</span>
                            {% else %}
                            <span class="badge bg-warning">{{ trade.status }}</span>
                            {% endif %}
                        </span>
                    </li>
                    {% if trade.volume > 0 %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Open Contracts</span>
                        <span class="text-end">{{ trade.volume }}</span>
                    </li>
                    {% endif %}


                    <li class="list-group-item d-flex justify-content-between">
                        <span>Adjusted Cost</span>
                        <span class="text-end">${{ trade.adjusted_cost }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Adjusted Proceeds</span>
                        <span class="text-end">${{ trade.adjusted_proceeds }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Time in Trade</span>
                        <span class="text-end">{{ trade.time_in_trade }} minutes</span>
                    </li>

                </ul>
            </div>
        </div>

    </div>
    <div class="col">
        <div class="card">
            <div class="card-body">
                <form action="{{ url_for('trades_bp.update_trade_notes', trade_id=trade.id) }}" method="POST">
                    <div class="mb-3">
                        <label for="trade_notes" class="form-label">Trade Notes</label>
                        <textarea id="trade_notes" name="trade_notes" class="form-control darkly-textarea" rows="10"
                            cols="50">{{ trade.trade_notes }}</textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Notes</button>
                </form>
            </div>
        </div>
    </div>
</div>
<br>
<div class="card">
    <div class="card-body">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date/Time</th>
                    <th>Action</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Adjusted Cost</th>
                    <th>Adjusted Proceed</th>
                    <th>Gross P&amp;L</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in trade.orders %}
                <tr>
                    <td>{{ order.formatted_date_time }}</td>
                    <td>
                        {% if order.is_buy_order() %}
                        <span class="badge bg-success">Buy</span> <!-- Green badge for Buy -->
                        {% elif order.is_sell_order() %}
                        <span class="badge bg-danger">Sell</span> <!-- Red badge for Sell -->
                        {% endif %}
                    </td>
                    <td>{{ order.quantity }}</td>
                    <td>${{ order.price }}</td>
                    <td>{% if order.is_buy_order() %}${{ order.adjusted_cost }}{% else %}--{% endif %}</td>
                    <td>{% if order.is_sell_order() %}${{ order.adjusted_proceeds }}{% else %}--{% endif %}</td>
                    <td>
                        {% if order.is_sell_order() %}
                        {% if order.gross_pnl %}
                        <span class="{% if order.gross_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">${{
                            order.gross_pnl }}</span>
                        {% else %}
                        --
                        {% endif %}
                        {% else %}
                        --
                        {% endif %}
                    </td>
                    <td>
                        <a href="#" class="btn btn-danger btn-sm delete-trade-btn" data-trade-id="{{ order.id }}"
                            data-bs-toggle="modal" data-bs-target="#confirmDeleteModal{{ order.id }}"><span
                                class="oi oi-trash"></span></a>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm edit-order-btn" data-order-id="{{ order.id }}"
                            data-date-time="{{ order.date_time.strftime('%Y-%m-%dT%H:%M') }}"
                            data-action="{{ order.action }}" data-price="{{ order.price }}"
                            data-quantity="{{ order.quantity }}" data-bs-toggle="modal"
                            data-bs-target="#editOrderModal{{ order.id }}"><span class="oi oi-pencil"></span>
                        </button>
                    </td>
                    <!-- Confirm Delete Modal -->
                    <div class="modal fade" id="confirmDeleteModal{{ order.id }}" tabindex="-1"
                        aria-labelledby="confirmDeleteModalLabel{{ order.id }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="confirmDeleteModalLabel{{ order.id }}">Confirm
                                        Delete
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    Are you sure you want to delete this order?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancel</button>
                                    <form action="{{ url_for('trades_bp.delete_order', order_id=order.id) }}"
                                        method="POST">
                                        {{ form.hidden_tag() }}
                                        <input type="hidden" name="_method" value="DELETE">
                                        <button type="submit" class="btn btn-danger">Delete</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Edit Order Modal -->
                    <div class="modal fade" id="editOrderModal{{ order.id }}" tabindex="-1"
                        aria-labelledby="editOrderModalLabel{{ order.id }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editOrderModalLabel{{ order.id }}">Edit Order
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editOrderForm"
                                        action="{{ url_for('trades_bp.update_order', order_id=order.id) }}"
                                        method="POST">
                                        {{ form.hidden_tag() }}
                                        <div class="mb-3">
                                            {{ form.date_time.label }}
                                            {{ form.date_time(class_='form-control date-time-picker',
                                            id='edit-date-time') }}
                                        </div>
                                        <div class="mb-3">
                                            {{ form.price.label }} {{ form.price(size=10, class_='form-control',
                                            id='edit-price') }}
                                        </div>
                                        <div class="mb-3">
                                            {{ form.action.label }}
                                            {{ form.action(class_="form-control", id='edit-action') }}
                                        </div>
                                        <div class="mb-3">
                                            {{ form.quantity.label }} {{ form.quantity(size=10,
                                            class_='form-control', id='edit-quantity') }}
                                        </div>
                                        <button class="btn btn-primary" type="submit">Save</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                </tr>
                {% endfor %}
            </tbody>
        </table>
        <!-- Collapsible form for adding a new order -->
        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#addOrderForm"
            aria-expanded="false" aria-controls="addOrderForm">
            Add Order <i class="bi bi-plus"></i>
        </button>
        <div class="collapse" id="addOrderForm">
            <div class="card card-body">
                <form method="POST" action="{{ url_for('trades_bp.add_order', trade_id=trade.id) }}"
                    onsubmit="return validateForm()">
                    {{ form.hidden_tag() }}
                    <div class="mb-3">
                        {{ form.date_time.label }}
                        {{ form.date_time(class_='form-control date-time-picker') }}
                    </div>
                    <div class="mb-3">
                        {{ form.price.label }} {{ form.price(size=10, class_='form-control', id='price-input') }}
                        <div id="price-error" class="error-message text-danger"></div>
                    </div>
                    <div class="mb-3">
                        {{ form.action.label }}
                        {{ form.action(class_="form-control") }}
                    </div>
                    <div class="mb-3">
                        {{ form.quantity.label }} {{ form.quantity(size=10, class_='form-control', id='quantity-input')
                        }}
                        <div id="quantity-error" class="error-message text-danger"></div>
                    </div>

                    <button class="btn btn-primary" type="submit">Submit</button>
                </form>
            </div>
        </div>
    </div>
</div>
<br>
<div class="card">
    <div class="card-body">
        <h5 class="card-title">Image Gallery</h5>
        {% if trade.images %}
        <div class="row">
            {% for image in trade.images %}
            <div class="col-md-4">
                <a data-bs-toggle="modal" data-bs-target="#imageModal" data-bs-img-src="{{image.filename}}"
                    data-bs-img-alt="Image 1">
                    <img src="{{image.filename}}" alt="Image 1" class="img-thumbnail mb-2">
                </a>
                <form action="{{ url_for('trades_bp.delete_image', trade_id=trade.id) }}" method="POST"
                    class="delete-image-form">
                    <input type="hidden" name="image_path" value="{{ image.filename }}">
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                        data-bs-target="#confirmDeleteModal"><span class="oi oi-trash"></span></button>
                </form>
            </div>
            {% endfor%}
        </div>
        {% else %}
        <h6>No images found, please upload some</h6>
        {%endif%}
        <br>
        <form action="{{ url_for('trades_bp.upload_image', trade_id=trade.id) }}" method="POST"
            enctype="multipart/form-data">
            <div class="mb-3">
                <label for="image" class="form-label">Upload Images</label>
                <input type="file" id="image" name="image" accept="image/*" class="form-control">
            </div>

            <button type="submit" class="btn btn-primary">Upload</button>
        </form>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-body">
                <img id="modalImage" src="" alt="" class="img-fluid">
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this image?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<br>
<script src="{{ url_for('static', filename='js/add_order_validation.js') }}"></script>

<script>
    var deleteForm = document.querySelector('#imageModal form');
    var imagePathInput = document.querySelector('#imagePath');

    imageModal.addEventListener('show.bs.modal', function (event) {
        var triggerElement = event.relatedTarget;
        var imageSrc = triggerElement.getAttribute('data-bs-img-src');
        var imageAlt = triggerElement.getAttribute('data-bs-img-alt');
        var imagePath = triggerElement.getAttribute('data-bs-img-path');

        var modalImage = imageModal.querySelector('#modalImage');
        modalImage.src = imageSrc;
        modalImage.alt = imageAlt;

        imagePathInput.value = imagePath;
    });

    deleteForm.addEventListener('submit', function (event) {
        var confirmation = confirm('Are you sure you want to delete this image?');
        if (!confirmation) {
            event.preventDefault();
        }
    });
</script>
<script>
    flatpickr('.date-time-picker', {
        enableTime: true,
        dateFormat: "Y-m-d H:i",  // Adjust the date and time format
        time_24hr: true,
        defaultDate: "today",
        defaultHour: new Date().getHours(),
        allowInput: true,
    });
</script>
<script>
    $(document).ready(function () {
        // When the edit order modal is opened, populate the form fields with the existing data
        $('.edit-order-btn').click(function () {
            var order_id = $(this).data('order-id');
            var date_time = $(this).data("date-time").replace("T", " ");
            var action = $(this).closest("tr").find(".badge").text();
            var price = $(this).data('price');
            var quantity = $(this).data('quantity');

            var modalSelector = '#editOrderModal' + order_id; // Unique modal selector

            $(modalSelector).modal('show');
            $(modalSelector + ' #edit-date-time').val(date_time);
            $(modalSelector + ' #edit-action').val(action);
            $(modalSelector + ' #edit-price').val(price);
            $(modalSelector + ' #edit-quantity').val(Math.abs(quantity));

        });
    });

</script>
{% endblock %}